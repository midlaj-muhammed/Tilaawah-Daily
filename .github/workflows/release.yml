name: Build and Release APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
  ANDROID_KEYSTORE_ALIAS: ${{ secrets.ANDROID_KEYSTORE_ALIAS }}
  ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
  ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Add JAXB Modules for JDK 17
      run: |
        # Add missing JAXB modules for Android SDK tools compatibility
        sudo apt-get update
        sudo apt-get install -y libjaxb-api-java libjaxb-java
        
    - name: Set JDK Version Check Override
      run: |
        echo "SKIP_JDK_VERSION_CHECK=true" >> $GITHUB_ENV
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Cache node modules
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
          
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
      
    - name: Setup Expo CLI
      run: npm install -g @expo/cli --legacy-peer-deps
      
    - name: Setup EAS CLI
      run: npm install -g eas-cli --legacy-peer-deps
      
    - name: Setup Android Build Environment
      run: |
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
        echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
        echo "$ANDROID_HOME/tools" >> $GITHUB_PATH
        echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
        # Accept Android licenses
        echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        echo "y" | $ANDROID_HOME/tools/bin/sdkmanager --licenses || true
        # Install required Android components
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" || true
        
    - name: Setup Android Keystore
      run: |
        echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > tilaawah-daily.keystore
        echo "Keystore created successfully"
        ls -la tilaawah-daily.keystore
        file tilaawah-daily.keystore
        
    - name: Configure Android Build
      run: |
        # Create gradle.properties with keystore configuration
        cat >> android/gradle.properties << 'EOF'
        MYAPP_RELEASE_STORE_FILE=../tilaawah-daily.keystore
        MYAPP_RELEASE_KEY_ALIAS=tilaawah-daily
        MYAPP_RELEASE_STORE_PASSWORD=tilaawah123
        MYAPP_RELEASE_KEY_PASSWORD=tilaawah123
        EOF
        echo "gradle.properties configured:"
        tail -4 android/gradle.properties
        
    - name: Create Google Services Config
      run: |
        # Create a minimal google-services.json for build to pass
        mkdir -p android/app/src/release
        cat > android/app/src/release/google-services.json << 'EOF'
        {
          "project_info": {
            "project_number": "232177874845",
            "project_id": "tilaawah-daily",
            "storage_bucket": "tilaawah-daily.firebasestorage.app"
          },
          "client": [
            {
              "client_info": {
                "mobilesdk_app_id": "1:232177874845:android:caa81dd0f57cc42897a174",
                "android_client_info": {
                  "package_name": "com.tilaawah.daily"
                }
              },
              "oauth_client": [],
              "api_key": [
                {
                  "current_key": "AIzaSyDummyKeyForBuildPurposesOnly"
                }
              ],
              "services": {
                "appinvite_service": {
                  "other_platform_oauth_client": []
                }
              }
            }
          ],
          "configuration_version": "1"
        }
        EOF
        echo "google-services.json created for build"
        
    - name: Check Android Project
      run: |
        echo "Checking Android project structure..."
        ls -la android/
        echo "Checking app build.gradle..."
        cat android/app/build.gradle | grep -A 10 -B 10 "signingConfigs" || echo "No signingConfigs found"
        
    - name: Build APK
      run: |
        cd android && ./gradlew assembleRelease
        
    - name: Find APK
      id: find_apk
      run: |
        # Local Expo build creates APK in android/app/build/outputs/apk/release
        APK_PATH=$(find android/app/build/outputs/apk/release -name "*.apk" | head -n 1)
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
        echo "Found APK: $APK_PATH"
        
    - name: Rename APK
      run: |
        cp ${{ steps.find_apk.outputs.apk_path }} Tilaawah-Daily-${{ github.ref_name || github.event.inputs.version }}.apk
        
    - name: Get APK info
      id: apk_info
      run: |
        APK_FILE=Tilaawah-Daily-${{ github.ref_name || github.event.inputs.version }}.apk
        APK_SIZE=$(du -h $APK_FILE | cut -f1)
        echo "apk_file=$APK_FILE" >> $GITHUB_OUTPUT
        echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name || github.event.inputs.version }}
        release_name: Tilaawah Daily ${{ github.ref_name || github.event.inputs.version }}
        body: |
          ## ğŸ“± Tilaawah Daily ${{ github.ref_name || github.event.inputs.version }}
          
          ### ğŸš€ Features
          - Daily Quran verses with translations
          - Progress tracking and statistics
          - Push notifications for reminders
          - Audio recitation support
          - Google authentication
          - Beautiful, responsive design
          
          ### ğŸ“¥ Installation
          1. Download the APK file below
          2. Enable "Install from unknown sources" on your Android device
          3. Install the APK file
          4. Launch Tilaawah Daily and enjoy!
          
          ### ğŸ“Š APK Information
          - **File**: ${{ steps.apk_info.outputs.apk_file }}
          - **Size**: ${{ steps.apk_info.outputs.apk_size }}
          - **Version**: ${{ github.ref_name || github.event.inputs.version }}
          - **Platform**: Android
          
          ---
          
          ğŸ™ *Made with love for the Muslim Ummah*
        draft: false
        prerelease: false
        files: |
          ${{ steps.apk_info.outputs.apk_file }}
